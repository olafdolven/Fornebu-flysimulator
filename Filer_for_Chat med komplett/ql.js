/*global window,document,self*/
(function(){if(typeof JSON!="object"){var e=document.createElement("script");e.type="text/javascript",e.src=document.location.protocol+"//cdnjs.cloudflare.com/ajax/libs/json2/20121008/json2.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}var n="//evt.quicklizard.com/event.gif",r="https://d3jdlwnuo8nsnr.cloudfront.net/sdk/v2.1/xdbridge.html",i=!!window.postMessage&&self===top,s={product:"product",confirmation:"confirmation",landing_page:"landing_page"},o=!1;try{o=top.location.search.indexOf("qldebug=1")>-1||sessionStorage&&sessionStorage.qldebug==="1"}catch(u){}var a={call:function(e){try{if(console&&typeof console[e]=="function"&&o){var t=Array.prototype.slice.call(arguments,1);t.unshift("(QL)"),console[e].apply(console,t)}}catch(n){}},log:function(){var e=Array.prototype.slice.call(arguments,0);e.unshift("log"),a.call.apply(a,e)},warn:function(){var e=Array.prototype.slice.call(arguments,0);e.unshift("warn"),a.call.apply(a,e)},error:function(){var e=Array.prototype.slice.call(arguments,0);e.unshift("error"),a.call.apply(a,e)}},f={genRandomString:function(){return(Math.floor(Math.random()*1e15)+(new Date).getMilliseconds()).toString(16).toUpperCase()},randomString:function(){return f.genRandomString()+f.genRandomString()},isArray:function(e){return!!(e&&e.concat&&e.unshift&&!e.callee)},inArray:function(e,t){if(typeof t.indexOf=="function")return t.indexOf(e)>-1;for(var n=0,r=t.length;n<r;n++)if(t[n]===e)return n;return!1},addEvent:function(e,t,n){if(e.addEventListener)return e.addEventListener(t,n,!1);if(e.attachEvent)return e.attachEvent("on"+t,n)},cloneObject:function(e){var t=JSON.stringify(e);return JSON.parse(t)}},l={o:{},first_run:!0,xd_src:null,getXDSrc:function(){return r},init:function(e){this.enabled=!1,this.xd_src=this.getXDSrc(),this.cb=e,this.timer=null,this.addFrame()},get:function(e){return this.o[e]},set:function(e,t,n){this.o[e]=t,n&&this.flush()},remove:function(e,t){delete this.o[e],t&&this.flush()},flush:function(){this.enabled&&this.frame.contentWindow.postMessage(JSON.stringify(this.o),"*")},addFrame:function(){var e=this;f.addEvent(window,"message",function(t){e.onXDMessage(t)},!1),this.frame=document.createElement("iframe"),this.frame.setAttribute("width",1),this.frame.setAttribute("height",1),this.frame.style.position="absolute",this.frame.style.top="-100px",this.frame.style.width="1px",this.frame.style.height="1px",this.frame.src=this.xd_src,document.body.appendChild(this.frame),this.timer=setTimeout(function(){a.log("XdFrame not loaded after 2s. Disabling..."),e.cb(),h.sendVid=!1},2e3)},onXDMessage:function(e){this.enabled=!0,this.timer!==null&&(clearTimeout(this.timer),this.timer=null);try{if(this.xd_src.indexOf(e.origin)<0)return;var t=JSON.parse(e.data);if(t.token===undefined)return;this.o=t,this.first_run&&(this.cleanup(),this.flush(),this.first_run=!1),this.cb()}catch(n){a.log(n)}},cleanup:function(){var e=(new Date).getTime();for(var t in this.o)if(this.o.hasOwnProperty(t)&&t.indexOf("lp_")===0){var n=this.o[t];for(var r=0,i=n.length;r<i;r++){var s=n[r];s.ex<e&&(n.splice(r,1),r--,i--)}n.length===0&&delete this.o[t]}}},c={getVisitorId:function(){var e=l.get("vid");return e===undefined&&(e=f.randomString(),l.set("vid",e,!0)),e},getOptOutFlag:function(){var e=l.get("opt_out");return e==="1"},getEventURL:function(e){var t=[];return t.push("event="+encodeURIComponent(JSON.stringify(e))),t.push("ts="+(new Date).getTime()+"."+Math.random().toString(36).substring(2,15)),[n,t.join("&")].join("?")},buildEventDataObject:function(e,t,n,r){var s,o,u={uid:e,meta:{price:t}},a=["ma_price","display_image","currency","inventory"];n&&(u.meta.permalink=n),i&&h.sendVid&&(u.meta.vid=l.get("vid")),document.referrer&&document.referrer.length>0&&(u.meta.referrer=document.referrer),o=r||{};for(s in o)o.hasOwnProperty(s)&&!u.hasOwnProperty(s)&&(a.indexOf(s)>-1?u.meta[s]=o[s]:u[s]=o[s]);if(u.uid){var f=c.getProductListingsByUid(u.uid);f.length>0&&(u.meta.lps=f)}return u},sendEvent:function(e){e.client_key=h.client_key;var t=document.getElementsByTagName("body")[0],n=c.getEventURL(e),r=document.createElement("img");r.src=n,r.width=r.height=1,r.setAttribute("style","position:absolute;top:-1000px"),r.onload=function(){t.removeChild(this),a.log("Event sent to Quicklizard",e)},a.log("Sending event to Quicklizard",e),t.appendChild(r)},saveProductListingUids:function(e){var t=e.permalink||top.location.href,n=e.meta.uids||[],r=(new Date).getTime()+108e5;for(var i=0,s=n.length;i<s;i++){var o=n[i],u="lp_"+o,a=l.get(u)||[];for(var f=0,c=a.length;f<c;f++){var h=a[f];h.url===t&&(a.splice(f,1),f--,c--)}a.push({url:t,ex:r}),l.set(u,a)}l.flush()},getProductListingsByUid:function(e){var t="lp_"+e,n=l.get(t)||[],r=[],i=(new Date).getTime();for(var s=0,o=n.length;s<o;s++){var u=n[s];u.ex<i?(n.splice(s,1),s--,o--):r.push(u.url)}return n.length>0?l.set(t,n,!0):l.remove(t,!0),r}},h=function(e){return a.warn("Deprecation Notice: Creating new QL instances will be removed from future versions"),a.warn("Please call QL directly rather than creating a new instance"),a.log("Please read our new SDK docs. on http://sdk.quicklizard.com/sdk/docs/index.html"),h.init(e)};h.init=function(e,t){if(e===undefined)return a.log("Client key cannot be empty");var n=c.getOptOutFlag();return h.client_key=e,n?h.sendVid=!1:t===undefined?h.sendVid=!0:h.sendVid=t,i&&(h.vid=c.getVisitorId()),a.log("visitor ID is",h.sendVid?"enabled":"disabled"),h},h.sendProductEvent=function(e,t,n,r){var i,o;return Object.prototype.toString.call(e)==="[object Object]"?(i=e,a.warn("You are using an older version of the Quicklizard SDK, which will be deprecated in the near future. Please read our new SDK docs. on http://sdk.quicklizard.com/sdk/docs/index.html")):i=c.buildEventDataObject(e,t,n,r),h.validateProductEvent(i)?(o={data:i,name:s.product},c.sendEvent(o)):a.error("Sending product page event failed"),h},h.sendConfirmationEvent=function(e,t,n){var r,i;return Object.prototype.toString.call(e)==="[object Object]"?(r=e,a.warn("You are using an older version of the Quicklizard SDK, which will be deprecated in the near future. Please read our new SDK docs. on http://sdk.quicklizard.com/sdk/docs/index.html")):r=c.buildEventDataObject(e,t),r.meta.new_user=n||!1?1:0,h.validateConfirmationEvent(r)?(i={data:r,name:s.confirmation},c.sendEvent(i)):a.error("Sending confirmation page event failed"),h},h.sendProductListingPageEvent=function(e,t,n){var r,i;return Object.prototype.toString.call(e)==="[object Object]"?(r=e,a.warn("You are using an older version of the Quicklizard SDK, which will be deprecated in the near future. Please read our new SDK docs. on http://sdk.quicklizard.com/sdk/docs/index.html")):r={name:t,permalink:n,meta:{uids:e}},h.validateProductListingEvent(r)?(i={data:r,name:s.landing_page},c.saveProductListingUids(r),c.sendEvent(i)):a.error("Sending product listing page event failed"),h},h.sendLandingPageEvent=function(e){h.sendProductListingPageEvent(e)},h.validateProductEvent=function(e){return!e.hasOwnProperty("uid")||typeof e.uid=="undefined"?(a.error("Product page event data must contain a uid"),!1):typeof e.uid!="string"?(a.error("Product page event uid must be a string"),!1):e.uid.length===0?(a.error("Product page event uid cannot be empty"),!1):!e.hasOwnProperty("meta")||typeof e.meta=="undefined"?(a.error("Product page event data must have a meta object"),!1):!e.meta.hasOwnProperty("price")||typeof e.meta.price=="undefined"?(a.error("Product page event data must include a price"),!1):(typeof e.meta.price=="string"&&(e.meta.price=parseFloat(e.meta.price,10),a.warn("Product page event price is formatted as a string")),typeof e.meta.price!="number"?(a.error("Product page event price must be a number"),!1):!e.meta.hasOwnProperty("permalink")||typeof e.meta.permalink=="undefined"?(a.error("Product page event must include a permalink"),!1):!0)},h.validateConfirmationEvent=function(e){return!e.hasOwnProperty("uid")||typeof e.uid=="undefined"?(a.error("Confirmation page event data must contain a uid"),!1):typeof e.uid!="string"?(a.error("Confirmation page uid must be a string"),!1):e.uid.length===0?(a.error("Confirmation page uid cannot be empty"),!1):!e.hasOwnProperty("meta")||typeof e.meta=="undefined"?(a.error("Confirmation page event data must have a meta object"),!1):!e.meta.hasOwnProperty("price")||typeof e.meta.price=="undefined"?(a.error("Confirmation page event data must include a price"),!1):(typeof e.meta.price=="string"&&(e.meta.price=parseFloat(e.meta.price,10),a.warn("Confirmation page price is formatted as a string")),typeof e.meta.price!="number"?(a.error("Confirmation page price must be a number"),!1):!0)},h.validateProductListingEvent=function(e){return(!e.hasOwnProperty("name")||typeof e.name=="undefined")&&a.error("Product listing page event data should contain a name"),!e.hasOwnProperty("permalink")||typeof e.permalink=="undefined"?(a.error("Product listing page event data must contain a permalink"),!1):!e.hasOwnProperty("meta")||typeof e.meta=="undefined"?(a.error("Product listing page event data must have a meta object"),!1):!e.meta.hasOwnProperty("uids")||typeof e.meta.uids=="undefined"?(a.error("Product listing page event must contain a uids array"),!1):f.isArray(e.meta.uids)?e.meta.uids.length===0?(a.error("Product listing page event uids is an empty array"),!1):!0:(a.error("Product listing page event uids is not an array"),!1)},h.getUpSellRecommendations=function(e,t){},h.getCrossSellRecommendations=function(e,t){};if(typeof window.QLAsync=="function"){var p=function(){window.QLAsync.call(window,h)};a.log(i),i?l.init(p):p()}else a.error("QLAsync is not a function. Cannot run Quicklizard SDK. Please refer to our SDK docs on http://sdk.quicklizard.com/sdk/docs/index.html")})();