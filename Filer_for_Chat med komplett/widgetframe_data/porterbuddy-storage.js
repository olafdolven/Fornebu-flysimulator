!function(){"use strict";var e=setTimeout;function t(e){return Boolean(e&&void 0!==e.length)}function n(){}function o(e){if(!(this instanceof o))throw new TypeError("Promises must be constructed via new");if("function"!=typeof e)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],a(e,this)}function r(e,t){for(;3===e._state;)e=e._value;0!==e._state?(e._handled=!0,o._immediateFn((function(){var n=1===e._state?t.onFulfilled:t.onRejected;if(null!==n){var o;try{o=n(e._value)}catch(e){return void i(t.promise,e)}u(t.promise,o)}else(1===e._state?u:i)(t.promise,e._value)}))):e._deferreds.push(t)}function u(e,t){try{if(t===e)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var n=t.then;if(t instanceof o)return e._state=3,e._value=t,void s(e);if("function"==typeof n)return void a((r=n,u=t,function(){r.apply(u,arguments)}),e)}e._state=1,e._value=t,s(e)}catch(t){i(e,t)}var r,u}function i(e,t){e._state=2,e._value=t,s(e)}function s(e){2===e._state&&0===e._deferreds.length&&o._immediateFn((function(){e._handled||o._unhandledRejectionFn(e._value)}));for(var t=0,n=e._deferreds.length;t<n;t++)r(e,e._deferreds[t]);e._deferreds=null}function c(e,t,n){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof t?t:null,this.promise=n}function a(e,t){var n=!1;try{e((function(e){n||(n=!0,u(t,e))}),(function(e){n||(n=!0,i(t,e))}))}catch(e){if(n)return;n=!0,i(t,e)}}o.prototype.catch=function(e){return this.then(null,e)},o.prototype.then=function(e,t){var o=new this.constructor(n);return r(this,new c(e,t,o)),o},o.prototype.finally=function(e){var t=this.constructor;return this.then((function(n){return t.resolve(e()).then((function(){return n}))}),(function(n){return t.resolve(e()).then((function(){return t.reject(n)}))}))},o.all=function(e){return new o((function(n,o){if(!t(e))return o(new TypeError("Promise.all accepts an array"));var r=Array.prototype.slice.call(e);if(0===r.length)return n([]);var u=r.length;function i(e,t){try{if(t&&("object"==typeof t||"function"==typeof t)){var s=t.then;if("function"==typeof s)return void s.call(t,(function(t){i(e,t)}),o)}r[e]=t,0==--u&&n(r)}catch(e){o(e)}}for(var s=0;s<r.length;s++)i(s,r[s])}))},o.resolve=function(e){return e&&"object"==typeof e&&e.constructor===o?e:new o((function(t){t(e)}))},o.reject=function(e){return new o((function(t,n){n(e)}))},o.race=function(e){return new o((function(n,r){if(!t(e))return r(new TypeError("Promise.race accepts an array"));for(var u=0,i=e.length;u<i;u++)o.resolve(e[u]).then(n,r)}))},o._immediateFn="function"==typeof setImmediate&&function(e){setImmediate(e)}||function(t){e(t,0)},o._unhandledRejectionFn=function(e){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",e)};var f,l,d=(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.storageFactory=function(e){var t={};function n(){try{var t="__some_random_key_you_are_not_going_to_use__";return e().setItem(t,t),e().removeItem(t),!0}catch(e){return!1}}return{getItem:function(o){return n()?e().getItem(o):t.hasOwnProperty(o)?t[o]:null},setItem:function(o,r){n()?e().setItem(o,r):t[o]=String(r)},removeItem:function(o){n()?e().removeItem(o):delete t[o]},clear:function(){n()?e().clear():t={}},key:function(o){return n()?e().key(o):Object.keys(t)[o]||null},get length(){return n()?e().length:Object.keys(t).length}}}}(f={exports:{}},f.exports),f.exports);(l=d)&&l.__esModule&&Object.prototype.hasOwnProperty.call(l,"default")&&l.default;var p,h=d.storageFactory;try{p=h((function(){return localStorage}))}catch(e){p={length:0,clear:function(){},getItem:function(e){return"debug"===e?"pb:*":null},key:function(e){return null},removeItem:function(e){},setItem:function(e,t){}}}var v=p,g=function(){if("undefined"!=typeof window&&window.process&&"renderer"===window.process.type)return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.webkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}(),m=[],y={};function w(e){return"hsl("+e[0]+","+e[1]+"%,"+e[2]+"%)"}var _=function(e){var t,n=v.getItem("debug");if(y[e])return y[e];if(n&&(e===n||/\*$/.test(n)&&e.substr(0,n.length-1)===n.substr(0,n.length-1))){if(g){var o=function(e){var t=m.indexOf(e);-1===t&&(t=m.push(e));var n=(30*t+(t%2?128:0))%255,o=Math.floor(30*t/255)%2?50:100;return[n,o,40]}(e),r=w(o),u=w([(t=o)[0],t[1],94]);y[e]=Function.prototype.bind.call(console.log,console,"%c"+e,"color: "+r+"; background-color: "+u+"; padding-left: 5px; padding-right: 5px;")}else y[e]=Function.prototype.bind.call(console.log,console,e);return y[e]}return y[e]=function(){return null},y[e]}("pb:storageframe"),b="function"!=typeof fetch,C="function"==typeof fetch?fetch:function(e,t){return t=t||{},new o((function(n,r){var u=new XMLHttpRequest,i=[],s=[],c={},a=function(){return{ok:2==(u.status/100|0),statusText:u.statusText,status:u.status,url:u.responseURL,text:function(){return o.resolve(u.responseText)},json:function(){return o.resolve(JSON.parse(u.responseText))},blob:function(){return o.resolve(new Blob([u.response]))},clone:a,headers:{keys:function(){return i},entries:function(){return s},get:function(e){return c[e.toLowerCase()]},has:function(e){return e.toLowerCase()in c}}}};for(var f in u.open(t.method||"get",e,!0),u.onload=function(){u.getAllResponseHeaders().replace(/^(.*?):[^\S\n]*([\s\S]*?)$/gm,(function(e,t,n){i.push(t=t.toLowerCase()),s.push([t,n]),c[t]=c[t]?c[t]+","+n:n})),n(a())},u.onerror=r,u.withCredentials="include"==t.credentials,t.headers)u.setRequestHeader(f,t.headers[f]);u.send(t.body||null)}))},I=function(e,t,n){var o={action:"get_response",value:e};t?t.postMessage(o,n):console.error("Could not respond to getItem request for postCode because event source was null!")},x=function(e,t,n){var o={action:"set_response",value:e?"SUCCESS":"FAILURE"};t?t.postMessage(o,n):console.error("Could not respond to setItem request for postCode because event source was null!")},j=function(e){if(e.data){_("event received "+e.data.action);var t=e.data;"getPostCode"===t.action?(n=e.source,o=e.origin,_("Reading postCode"),C("store/postcode.html",{method:"GET",headers:{"x-porterbuddy-referer":o}}).then((function(e){e.text().then((function(e){var t=function(e){var t=e.indexOf("postCode="),n=e.substring(t+9),o=n.indexOf("<");return n.substring(0,o)}(e);if(_("Fetched postcode from cache: "+t),"-1"!==t)v.setItem("postCode",t),I(t,n,o);else{var r=v.getItem("postCode");_("Using postcode from local storage "+r),I(r||"-1",n,o)}}),(function(){_("Postcode from cache unavailable, fetching from local storage");var e=v.getItem("postCode");I(e,n,o)}))}))):"setPostCode"===t.action&&t.value?function(e,t,n){_("Storing [postCode]="+n),v.setItem("postCode",n),C("store/postcode.html",{method:"GET",headers:{"x-porterbuddy-postcode":n,"x-porterbuddy-maxagezero":String(b),"x-porterbuddy-referer":t},cache:"reload"}).then((function(){_("Refreshed cached postcode"),x(!0,e,t)}),(function(n){_("could not refresh postcode in cache, because "+n),x(!1,e,t)}))}(e.source,e.origin,t.value):"clearPostCode"===t.action&&(_("Removing [postCode]"),v.removeItem("postCode"))}var n,o};window.addEventListener("message",j,!1),_("StorageFrame available")}();
//# sourceMappingURL=porterbuddy-storage.js.map
